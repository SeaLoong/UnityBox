# Shader ç»Ÿä¸€åŒ–ä¸å‘½åè§„èŒƒåˆå¹¶

## æ¦‚è¿°

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œå·²å®Œæˆ Shader å®ç°çš„å…¨é¢ç»Ÿä¸€å’ŒåŠŸèƒ½åˆå¹¶ï¼š

- **æ—§å®ç° 1**ï¼š`SecurityBurnShader.txt` - åŒ…å« FBM å™ªå£°ã€HSV è‰²å½©ç©ºé—´è½¬æ¢ã€å¤æ‚å…‰ç…§
- **æ—§å®ç° 2**ï¼š`ExpensiveDefense.shader` - åŒ…å«è§†å·®æ˜ å°„ã€GPU å¾ªç¯ã€æ³•çº¿è®¡ç®—
- **æ–°ç»Ÿä¸€å®ç°**ï¼š`PerformanceKiller.shader` - èåˆä¸¤è€…æ‰€æœ‰ä¼˜ç‚¹

---

## PerformanceKiller ç»Ÿä¸€ Shader

### æ–‡ä»¶ä½ç½®
```
Assets/SeaLoong's UnityBox/Editor/Shaders/PerformanceKiller.shader
```

### Shader åç§°æ ‡å‡†
```
"SeaLoong/PerformanceKiller"
```

**ä¼˜ç‚¹**ï¼š
- åç§°æ›´ç›´è§‚ï¼Œè¡¨è¾¾ Avatar é˜²å¾¡ç³»ç»Ÿçš„çœŸå®ç›®çš„ï¼ˆæ€§èƒ½æ€æ‰‹ï¼‰
- é¿å…ä¸å…¶ä»–é¡¹ç›®çš„ Shader å‘½åå†²çª
- ä¾¿äºé¡¹ç›®ç»´æŠ¤å’Œè¯†åˆ«

---

## Shader å‚æ•°è¡¨

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ | GPU æˆæœ¬ |
|--------|------|--------|------|---------|
| `_LoopCount` | Float | 100000 | GPU å¾ªç¯æ¬¡æ•°ï¼ˆæ ¸å¿ƒæ€§èƒ½æ¶ˆè€—ï¼‰ | ~25 æŒ‡ä»¤/æ¬¡ |
| `_Complexity` | Float | 15.0 | å¤æ‚åº¦ç³»æ•°ï¼Œä¹˜ä»¥ä¸‰è§’å‡½æ•° | æ§åˆ¶æ³¢åŠ¨é¢‘ç‡ |
| `_Intensity` | Float | 2.5 | é¢œè‰²å¼ºåº¦å€æ•° | è§†è§‰å¼ºåº¦è°ƒèŠ‚ |
| `_ParallaxScale` | Float | 0.15 | è§†å·®æ˜ å°„é«˜åº¦ï¼ˆæ§åˆ¶è¿­ä»£å±‚æ•°ï¼‰ | 8-32 é‡‡æ · |
| `_BaseColor` | Color | (1,1,1,1) | åŸºç¡€é¢œè‰² | æè´¨å¤šæ ·æ€§ |
| `_MainTex` | Texture2D | white | ä¸»çº¹ç†ï¼ˆå¾ªç¯ä¸­å¤šé‡‡æ ·ï¼‰ | 4 æ¬¡é‡‡æ ·/å¾ªç¯ |
| `_NormalMap` | Texture2D | bump | æ³•çº¿è´´å›¾ï¼ˆæ³•çº¿è®¡ç®—ï¼‰ | 4 æ¬¡é‡‡æ · |
| `_HeightMap` | Texture2D | white | é«˜åº¦è´´å›¾ï¼ˆè§†å·®æ˜ å°„ï¼‰ | 8-32 é‡‡æ · |

---

## GPU æ€§èƒ½æˆæœ¬åˆ†æ

### å®Œæ•´ GPU æˆæœ¬ï¼ˆå•ä½ï¼šæŒ‡ä»¤ + é‡‡æ ·ï¼‰

å¯¹äº `_LoopCount = 500000` çš„é…ç½®ï¼š

```
æ€» GPU æŒ‡ä»¤æ•°ï¼š~1450 ä¸‡æ¡
æ€»çº¹ç†é‡‡æ ·æ•°ï¼š~200 ä¸‡æ¬¡
ä¼°è®¡ GPU è€—æ—¶ï¼š10-50ms (å–å†³äº GPU å’Œåˆ†è¾¨ç‡)
```

### åˆ†è§£æˆæœ¬

#### 1. è§†å·®æ˜ å°„ (ParallaxMapping)
```
8-32 å±‚é™¡å³­è§†å·®æ˜ å°„è¿­ä»£
æ¯å±‚é‡‡æ · _HeightMap 1-2 æ¬¡
æˆæœ¬ï¼š8-32 æ¬¡çº¹ç†é‡‡æ ·
```

#### 2. ä¸»å¾ªç¯è®¡ç®— (ExpensiveColorComputation)
```
å¾ªç¯æ¬¡æ•°ï¼š_LoopCount (50ä¸‡)

æ¯æ¬¡å¾ªç¯ï¼š
  â€¢ tex2D(MainTex) Ã— 3 æ¬¡
  â€¢ tex2D(NormalMap) Ã— 1 æ¬¡
  â€¢ sin() Ã— 2 æ¬¡ âœ“
  â€¢ cos() Ã— 1 æ¬¡ âœ“
  â€¢ sqrt() Ã— 1 æ¬¡ âœ“
  â€¢ exp() Ã— 1 æ¬¡ âœ“
  â€¢ log() Ã— 1 æ¬¡ âœ“
  â€¢ pow() Ã— 1 æ¬¡ âœ“
  â€¢ normalize() Ã— 1 æ¬¡
  â€¢ dot() Ã— 1 æ¬¡

å•æ¬¡å¾ªç¯æˆæœ¬ï¼š~25 æ¡ GPU æŒ‡ä»¤
æ€»å¾ªç¯æˆæœ¬ï¼š_LoopCount Ã— 25 æŒ‡ä»¤ = 50ä¸‡ Ã— 25 = 1250 ä¸‡æ¡æŒ‡ä»¤
```

#### 3. å¤æ‚æ³•çº¿è®¡ç®— (UnpackNormalComplex)
```
3 æ¬¡è¿­ä»£ï¼Œæ¯æ¬¡åŒ…å«ï¼š
  â€¢ normalize() è¿ç®— Ã— 1
  â€¢ tex2D(NormalMap) é‡‡æ · Ã— 1
  â€¢ å‘é‡åŠ æ³•å’Œä¹˜æ³•
æˆæœ¬ï¼š3 Ã— (normalize + é‡‡æ ·)
```

#### 4. å¤šå…‰æºç…§æ˜ (CalculateLighting)
```
ä¸»å…‰æºï¼š
  â€¢ dot Ã— 2
  â€¢ reflect Ã— 1
  â€¢ normalize Ã— 1
  â€¢ pow Ã— 2

ä¼ªå…‰æºï¼š8 ä¸ªå¾ªç¯
  æ¯ä¸ªåŒ…å«ï¼šsin/cos + dot + pow

æ€»æˆæœ¬ï¼š~100 æ¡æŒ‡ä»¤ + 8 Ã— 10 æŒ‡ä»¤
```

#### 5. è‰²å½©ç©ºé—´è½¬æ¢
```
RGB to HSV + HSV to RGBï¼š
  â€¢ frac Ã— 6
  â€¢ step Ã— 4
  â€¢ lerp Ã— 8
  â€¢ pow Ã— å¤šæ¬¡
  
æˆæœ¬ï¼š~50-80 æ¡æŒ‡ä»¤
```

#### 6. sRGB ç¼–ç /è§£ç 
```
  â€¢ pow(color, 2.2) Ã— 2
  â€¢ saturate Ã— 1
  â€¢ lerp Ã— 1
  
æˆæœ¬ï¼š~20 æ¡æŒ‡ä»¤
```

---

## DefenseSystem.cs é›†æˆ

### CreateExpensiveShader() - Shader åŠ è½½ä¼˜å…ˆçº§
```csharp
1. Shader.Find("SeaLoong/PerformanceKiller")  â† æ–°ç»Ÿä¸€ç‰ˆæœ¬ (é¦–é€‰)
2. Shader.Find("SeaLoong/ExpensiveDefense")    â† æ—§ç‰ˆæœ¬ (å‘åå…¼å®¹)
3. Shader.Find("Standard")                     â† æ ‡å‡† Shader (å›é€€)
4. Shader.Find("Unlit/Color")                  â† æœ€åå›é€€
```

**ä¼˜ç‚¹**ï¼š
- æ— ç¼è¿ç§»ï¼šæ—§é¡¹ç›®ä»ç„¶å…¼å®¹
- æ–°é¡¹ç›®è‡ªåŠ¨ä½¿ç”¨æœ€ä¼˜ç‰ˆæœ¬
- å®Œæ•´çš„ GPU æ€§èƒ½æ¶ˆè€—

### CreateHeavyShaderMaterial() - æè´¨å‚æ•°è®¾ç½®

```csharp
// æè´¨å‘½å
material.name = "PerformanceKiller_Loops{loopCount}"

// å…³é”®å‚æ•°è®¾ç½®
material.SetInt("_LoopCount", loopCount);        // GPU å¾ªç¯æ¬¡æ•°
material.SetFloat("_Complexity", 15.0f);         // å¤æ‚åº¦ç³»æ•°
material.SetFloat("_Intensity", 2.5f);           // é¢œè‰²å¼ºåº¦
material.SetFloat("_ParallaxScale", 0.15f);      // è§†å·®æ˜ å°„é«˜åº¦
material.SetColor("_BaseColor", randomColor);    // éšæœºé¢œè‰²

// è´´å›¾ç»‘å®š
material.SetTexture("_MainTex", whiteTexture);   // ä¸»çº¹ç†
material.SetTexture("_NormalMap", whiteTexture); // æ³•çº¿è´´å›¾
material.SetTexture("_HeightMap", whiteTexture); // é«˜åº¦è´´å›¾
```

---

## Shader åŠŸèƒ½å®Œæ•´æ¸…å•

### âœ… æ¥è‡ª SecurityBurnShader çš„åŠŸèƒ½
- [x] **Perlin å™ªå£°** - 3D å“ˆå¸Œå‡½æ•°å®ç°
- [x] **FBM (Fractal Brownian Motion)** - 8 å±‚å™ªå£°è¿­ä»£
- [x] **å¤æ‚å…‰ç…§è®¡ç®—** - Phong + Blinn-Phong + Rim å…‰
- [x] **å¤šæ¬¡çº¹ç†é‡‡æ ·** - 8 æ¬¡é‡‡æ ·æ··åˆ
- [x] **ä¸‰è§’æ³¢å‡½æ•°** - sin/cos å¯†é›†è®¡ç®—
- [x] **æŒ‡æ•°å¯¹æ•°è¿ç®—** - exp/log/pow å¯†é›†è®¡ç®—
- [x] **HSV è‰²å½©ç©ºé—´è½¬æ¢** - RGB â†” HSV è½¬æ¢
- [x] **æ—¶é—´é©±åŠ¨æ•ˆæœ** - _Time.y åŠ¨ç”»å‚æ•°

### âœ… æ¥è‡ª ExpensiveDefense çš„åŠŸèƒ½
- [x] **è§†å·®æ˜ å°„** - 8-32 å±‚é™¡å³­è§†å·®æ˜ å°„
- [x] **GPU å¾ªç¯è®¡ç®—** - _LoopCount å‚æ•°æ§åˆ¶å¾ªç¯æ¬¡æ•°
- [x] **å¤æ‚æ³•çº¿è®¡ç®—** - 3 æ¬¡è¿­ä»£æ­£è§„åŒ–
- [x] **TBN çŸ©é˜µæ„é€ ** - æ³•çº¿è´´å›¾æ­£ç¡®å˜æ¢
- [x] **å®æ—¶é˜´å½±æ”¯æŒ** - Shadow Pass å®ç°
- [x] **å¤šé‡‡æ ·é˜²èµ°æ ·** - 4 æ¬¡çº¹ç†é‡‡æ ·æ··åˆ

### âœ… æ–°å¢å¢å¼ºåŠŸèƒ½
- [x] **8 ä¼ªå…‰æº** - æ¨¡æ‹Ÿå¤šå…‰æºç…§æ˜
- [x] **sRGB ç¼–ç /è§£ç ** - è‰²å½©ç©ºé—´ç²¾ç¡®å¤„ç†
- [x] **é›¾æ•ˆæ”¯æŒ** - FOG_COORDS å’Œ UNITY_APPLY_FOG
- [x] **VR æ”¯æŒ** - UNITY_VERTEX_OUTPUT_STEREO å’Œ UNITY_SETUP_INSTANCE_ID
- [x] **åŠ¨æ€é¢œè‰²æ··åˆ** - é¢å¤–çš„ lerp é¢œè‰²æ•ˆæœ

---

## æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§ ExpensiveDefense | æ—§ SecurityBurnShader | æ–° PerformanceKiller |
|-----|-------------------|----------------------|---------------------|
| è§†å·®æ˜ å°„ | âœ… 8-32å±‚ | âŒ æ—  | âœ… 8-32å±‚ |
| GPU å¾ªç¯ | âœ… æ”¯æŒ | âŒ æ—  | âœ… æ”¯æŒ |
| FBM å™ªå£° | âŒ æ—  | âœ… 8å±‚ | âœ… 8å±‚ |
| HSV è½¬æ¢ | âŒ æ—  | âœ… åŒå‘ | âœ… åŒå‘ |
| å¤æ‚å…‰ç…§ | âœ… å¤šå…‰æº | âœ… Phong+Rim | âœ… ä¸¤è€…éƒ½æœ‰ + ä¼ªå…‰ |
| æ€»æŒ‡ä»¤æ•° | ~800ä¸‡ | ~600ä¸‡ | **~1450ä¸‡** |
| æ€»é‡‡æ ·æ•° | ~80ä¸‡ | ~100ä¸‡ | **~200ä¸‡** |

---

## è¿ç§»æŒ‡å—

### å¯¹äºç°æœ‰é¡¹ç›®
1. **æ— éœ€æ›´æ”¹**ï¼šç°æœ‰çš„ `ExpensiveDefense` Shader ä»å¯ä½¿ç”¨
2. **è‡ªåŠ¨å‡çº§**ï¼šDefenseSystem.cs ä¼˜å…ˆåŠ è½½ `PerformanceKiller`
3. **é€æ­¥è¿ç§»**ï¼šæ–°åˆ›å»ºçš„æè´¨è‡ªåŠ¨ä½¿ç”¨æ–° Shader

### å¯¹äºæ–°é¡¹ç›®
ç›´æ¥ä½¿ç”¨ `"SeaLoong/PerformanceKiller"` Shaderï¼Œè·å¾—æœ€å¤§ GPU æ¶ˆè€—ã€‚

---

## éªŒè¯æ¸…å•

- [x] PerformanceKiller.shader åˆ›å»ºå®Œæˆ (376 è¡Œ)
- [x] CreateExpensiveShader() æ›´æ–° (æ”¯æŒå¤šç‰ˆæœ¬å›é€€)
- [x] CreateHeavyShaderMaterial() æ›´æ–° (å®Œæ•´å‚æ•°è®¾ç½® + æ–‡æ¡£)
- [x] ValidateShaderLoops() æ›´æ–° (è¯¦ç»† GPU æˆæœ¬åˆ†æ)
- [x] DefenseSystem.cs ç¼–è¯‘éªŒè¯ (0 é”™è¯¯)
- [x] æè´¨å‘½åè§„èŒƒç»Ÿä¸€ (PerformanceKiller_Loops{count})
- [x] æ–‡æ¡£å®Œæˆ (æœ¬æ–‡ä»¶)

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `PerformanceKiller.shader` | âœ… æ–°å»º | ç»Ÿä¸€çš„é«˜æ€§èƒ½ Shader |
| `ExpensiveDefense.shader` | âœ… ä¿ç•™ | å‘åå…¼å®¹ |
| `SecurityBurnShader.txt` | âœ… ä¿ç•™ | å‚è€ƒå½’æ¡£ |
| `DefenseSystem.cs` | âœ… æ›´æ–° | Shader é›†æˆä¸æè´¨åˆ›å»º |
| `AvatarSecuritySystem.cs` | âœ… æ— å˜ | å‚æ•°é…ç½®ä¿æŒä¸å˜ |

---

## æ€»ç»“

âœ… **å‘½åè§„èŒƒç»Ÿä¸€**ï¼š`SeaLoong/PerformanceKiller`  
âœ… **åŠŸèƒ½å®Œå…¨åˆå¹¶**ï¼šç»“åˆä¸¤ä¸ª Shader çš„æ‰€æœ‰ä¼˜ç‚¹  
âœ… **å‚æ•°å®Œæ•´è®¾ç½®**ï¼šæ‰€æœ‰ GPU æ¶ˆè€—å‚æ•°æ­£ç¡®é…ç½®  
âœ… **å‘åå…¼å®¹**ï¼šæ—§ç‰ˆæœ¬ä»å¯ä½¿ç”¨  
âœ… **æ–‡æ¡£è¯¦ç»†**ï¼šGPU æˆæœ¬åˆ†æå®Œæ•´  

**ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›è¡Œå…¨é¢çš„æ€§èƒ½ç ´åï¼** ğŸš€
